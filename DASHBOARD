import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import dash
from dash import dcc, html, Input, Output
import dash_bootstrap_components as dbc
from io import StringIO

# Load the data
data = """id,timestamp,source,username,income_group,sector,reaction_text,sentiment,sentiment_score,reaction_intensity,keywords
1,2025-02-01 10:24,Twitter,@rahul_econ,Middle,Education,Increased allocation to govt schools is a great move!,Positive,0.82,High,"education, allocation"
2,2025-02-01 11:05,Twitter,@fin_guru,High,Taxation,New tax slabs are confusing and may hurt salaried class.,Negative,-0.65,Medium,"tax, salaried"
3,2025-02-01 11:58,News,TimesNow,All,Agriculture,Farmers welcome subsidy hike but worry about implementation.,Neutral,0.1,Medium,"agriculture, subsidy"
4,2025-02-01 12:30,Twitter,@mina_dev,Low,Healthcare,Free health insurance extension is a blessing!,Positive,0.91,High,"healthcare, insurance"
5,2025-02-01 13:10,Threads,@arpit,Middle,Transport,Metro expansion budget seems too low for actual needs.,Negative,-0.48,Low,"transport, metro"
6,2025-02-01 14:22,Survey,Respondent 42,Low,Food,Cheaper essential goods would help my family a lot.,Positive,0.76,Medium,"food, essentials"
7,2025-02-01 15:01,Twitter,@political_view,High,Defense,Defense budget increased againâ€¦ mixed feelings.,Neutral,0.02,Low,defense
8,2025-02-01 15:48,Reddit,user432,Middle,Employment,Jobs program sounds promising but let's see if it works.,Neutral,0.15,Medium,"employment, jobs"
9,2025-02-01 16:20,News,EconomicTimes,All,Industry,Industrial stimulus expected to boost manufacturing output.,Positive,0.66,High,"industry, stimulus"
10,2025-02-01 17:12,Twitter,@studentlife,Low,Education,Wish there were more scholarships in the budget.,Negative,-0.4,Low,"education, scholarship"
11,2025-02-01 18:05,Threads,@tech_guy,High,Technology,Tech R&D funding is a solid step forward!,Positive,0.87,High,"technology, R&D"
12,2025-02-01 18:54,Twitter,@common_man,Low,Taxation,No relief for lower-income taxpayers againâ€¦,Negative,-0.72,High,"tax, low-income"
13,2025-02-01 19:30,Survey,Respondent 89,Middle,Healthcare,Neutral about the changes nothing major for me.,Neutral,0.05,Low,healthcare
14,2025-02-01 20:22,Reddit,user19,High,Environment,Finally a stronger focus on climate action!,Positive,0.92,High,"climate, environment"
15,2025-02-01 21:11,News,NDTV,All,Housing,Affordable housing push may ease urban pressure.,Positive,0.61,Medium,housing
16,2025-02-02 09:02,Twitter,@aisha,Middle,Transport,Fuel tax hike is disappointing.,Negative,-0.67,High,"fuel, tax"
17,2025-02-02 09:55,Threads,@policynerd,High,Finance,Fiscal deficit target is ambitious but achievable.,Positive,0.54,Medium,"finance, deficit"
18,2025-02-02 10:48,Survey,Respondent 14,Low,Food,Food subsidies seem fair.,Neutral,0.2,Low,food
19,2025-02-02 11:30,News,IndiaToday,All,Agriculture,Budget fails to address irrigation challenges say experts.,Negative,-0.58,Medium,"agriculture, irrigation"
20,2025-02-02 12:10,Twitter,@urban_planner,Middle,Housing,Urban development budget is decent but could be better.,Neutral,0.12,Medium,"housing, urban"
21,2025-02-02 12:55,Twitter,@youth_voice,Low,Education,More focus on skill development is good!,Positive,0.74,Medium,"education, skills"
22,2025-02-02 13:20,Threads,@marketwatch,High,Finance,Stock market reacting cautiously to budget announcements.,Neutral,0.08,Low,"finance, market"
23,2025-02-02 13:55,Survey,Respondent 32,Middle,Healthcare,Would like to see more public hospitals built.,Negative,-0.33,Low,"healthcare, hospitals"
24,2025-02-02 14:40,Reddit,user928,Middle,Technology,AI funding might open new opportunities.,Positive,0.79,High,"technology, AI"
25,2025-02-02 15:18,News,LiveMint,All,Industry,Experts unsure if new incentives will attract investors.,Neutral,0.02,Medium,"industry, incentives"
26,2025-02-02 15:55,Twitter,@greener_planet,High,Environment,Green energy push is solid!,Positive,0.88,High,"environment, renewable"
27,2025-02-02 16:30,Threads,@naved,Low,Food,Wish basic food items had been cheaper.,Negative,-0.52,Medium,"food, prices"
28,2025-02-02 17:12,Survey,Respondent 77,Middle,Employment,Unemployment scheme gives me hope.,Positive,0.62,Medium,employment
29,2025-02-02 18:00,Twitter,@citizenvoice,Low,Taxation,Indirect tax increase hits us the hardest.,Negative,-0.75,High,"tax, indirect"
30,2025-02-02 18:40,News,ABPNews,All,Defense,Increased defense spending raises strategic confidence.,Positive,0.55,Medium,defense
31,2025-02-03 09:20,Twitter,@techie_raj,Middle,Technology,Hyped about the new digital infrastructure plans!,Positive,0.84,High,"technology, digital"
32,2025-02-03 09:55,Threads,@devanshi,High,Education,Higher education grants look decent this year.,Positive,0.63,Medium,"education, grants"
33,2025-02-03 10:10,Reddit,user990,Middle,Finance,Not sure about the new pension scheme model.,Neutral,-0.05,Medium,"finance, pension"
34,2025-02-03 11:05,Survey,Respondent 10,Low,Healthcare,Hospital fees should be reduced budget didn't help.,Negative,-0.49,High,"healthcare, fees"
35,2025-02-03 11:55,Twitter,@farmer_unity,Low,Agriculture,Minimum support price benefits are welcome!,Positive,0.77,High,"agriculture, MSP"
36,2025-02-03 12:40,News,Hindu,All,Housing,Real estate sector optimistic after announcements.,Positive,0.58,Medium,"housing, real-estate"
37,2025-02-03 13:25,Twitter,@ride_safe,Middle,Transport,Road expansion plan sounds exciting!,Positive,0.72,High,"transport, roads"
38,2025-02-03 14:10,Threads,@climate_warrior,High,Environment,More EV charging stations? Huge win!,Positive,0.89,High,"environment, EV"
39,2025-02-03 15:00,Survey,Respondent 60,Low,Food,Ration card benefits unchanged disappointed.,Negative,-0.44,Medium,"food, ration"
40,2025-02-03 15:50,Reddit,user111,Middle,Employment,Skill missions are always announced let's see the execution.,Neutral,0,Low,"employment, skills"
41,2025-02-03 16:30,Twitter,@tax_lawyer,High,Taxation,Corporate tax cut was expected.,Neutral,0.1,Low,"tax, corporate"
42,2025-02-03 17:05,News,MoneyControl,All,Finance,Markets show mixed sentiment post budget.,Neutral,-0.01,Medium,"finance, market"
43,2025-02-03 17:55,Threads,@homechef,Low,Food,No change in cooking gas subsidiesâ€¦ sad.,Negative,-0.62,High,"food, gas"
44,2025-02-03 18:20,Twitter,@it_student,Middle,Technology,Coding education boost is amazing!,Positive,0.86,High,"technology, coding"
45,2025-02-03 19:05,Survey,Respondent 03,High,Defense,Defense allocation feels justified.,Positive,0.44,Medium,defense
46,2025-02-04 09:10,Twitter,@urbanvoice,Middle,Housing,Better drainage system planned finally!,Positive,0.71,Medium,"housing, drainage"
47,2025-02-04 09:45,Reddit,user404,Middle,Environment,Climate policies still not aggressive enough.,Negative,-0.36,Low,"environment, climate"
48,2025-02-04 10:20,Threads,@startup_guy,High,Industry,Startup incentives look promising!,Positive,0.83,High,"industry, startup"
49,2025-02-04 11:05,News,ETNow,All,Transport,Railway modernization plan receives strong public support.,Positive,0.69,Medium,"transport, railway"
50,2025-02-04 11:40,Survey,Respondent 28,Low,Employment,Still no clarity on rural jobs.,Negative,-0.48,Medium,"employment, rural"
51,2025-02-04 12:15,Twitter,@greenfuture,High,Environment,Big push for plastic reduction is excellent.,Positive,0.93,High,"environment, plastic"
52,2025-02-04 12:55,Threads,@coding_cat,Middle,Technology,Cybersecurity funding is urgently needed good step.,Positive,0.75,High,"technology, cybersecurity"
53,2025-02-04 13:30,Reddit,user223,Middle,Food,Food waste reduction programs sound good.,Positive,0.61,Low,"food, waste"
54,2025-02-04 14:05,Survey,Respondent 36,Low,Healthcare,Medicine costs are still high not happy.,Negative,-0.57,Medium,"healthcare, medicines"
55,2025-02-04 14:40,News,HindustanTimes,All,Finance,Banking sector shows cautious optimism.,Neutral,0.07,Low,"finance, banking"
56,2025-02-04 15:15,Twitter,@daily_commuter,Middle,Transport,Bus travel concessions should've increased.,Negative,-0.35,Low,"transport, bus"
57,2025-02-04 15:50,Threads,@agrilife,Low,Agriculture,Fertilizer subsidy revision is helpful.,Positive,0.59,Medium,"agriculture, fertilizer"
58,2025-02-04 16:25,Reddit,user157,High,Education,Research fellowships finally get attention!,Positive,0.87,High,"education, research"
59,2025-02-04 17:05,News,RepublicTV,All,Defense,Mixed reactions to defense modernization plan.,Neutral,0.02,Medium,"defense, modernization"
60,2025-02-04 17:40,Twitter,@civic_watch,Middle,Housing,Smart city mission continues good to see progress.,Positive,0.64,Medium,"housing, smart-city"
"""

df = pd.read_csv(StringIO(data))
df['timestamp'] = pd.to_datetime(df['timestamp'])

# Initialize Dash app
app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])

# Define color scheme
COLORS = {
    'Positive': '#10b981',
    'Negative': '#ef4444',
    'Neutral': '#6b7280',
    'primary': '#3b82f6',
    'bg': '#f8fafc'
}

# App layout
app.layout = dbc.Container([
    # Header
    dbc.Row([
        dbc.Col([
            html.H1("ğŸ“Š Budget Reaction Analysis Dashboard", 
                   className="text-center mb-4 mt-4",
                   style={'color': '#1e293b', 'fontWeight': 'bold'})
        ])
    ]),
    
    # Filters
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.Label("Filter by Sector:", className="fw-bold mb-2"),
                    dcc.Dropdown(
                        id='sector-filter',
                        options=[{'label': 'All Sectors', 'value': 'All'}] + 
                                [{'label': s, 'value': s} for s in sorted(df['sector'].unique())],
                        value='All',
                        clearable=False
                    )
                ])
            ], className="mb-3")
        ], width=6),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.Label("Filter by Income Group:", className="fw-bold mb-2"),
                    dcc.Dropdown(
                        id='income-filter',
                        options=[{'label': 'All Groups', 'value': 'All'}] + 
                                [{'label': g, 'value': g} for g in ['Low', 'Middle', 'High']],
                        value='All',
                        clearable=False
                    )
                ])
            ], className="mb-3")
        ], width=6)
    ]),
    
    # KPI Cards
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H6("Total Reactions", className="text-muted"),
                    html.H2(id='kpi-total', className="mb-0", style={'color': COLORS['primary']})
                ])
            ])
        ], width=3),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H6("Avg Sentiment", className="text-muted"),
                    html.H2(id='kpi-avg', className="mb-0", style={'color': COLORS['primary']})
                ])
            ])
        ], width=3),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H6("Positive %", className="text-muted"),
                    html.H2(id='kpi-positive', className="mb-0", style={'color': COLORS['Positive']})
                ])
            ])
        ], width=3),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H6("Negative %", className="text-muted"),
                    html.H2(id='kpi-negative', className="mb-0", style={'color': COLORS['Negative']})
                ])
            ])
        ], width=3)
    ], className="mb-4"),
    
    # Charts Row 1
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Sentiment Distribution", className="card-title"),
                    dcc.Graph(id='sentiment-pie')
                ])
            ])
        ], width=6),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Sentiment by Income Group", className="card-title"),
                    dcc.Graph(id='income-bar')
                ])
            ])
        ], width=6)
    ], className="mb-4"),
    
    # Charts Row 2
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Sentiment by Sector", className="card-title"),
                    dcc.Graph(id='sector-bar')
                ])
            ])
        ], width=12)
    ], className="mb-4"),
    
    # Charts Row 3
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Reaction Intensity Distribution", className="card-title"),
                    dcc.Graph(id='intensity-bar')
                ])
            ])
        ], width=6),
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Sentiment Timeline", className="card-title"),
                    dcc.Graph(id='timeline-chart')
                ])
            ])
        ], width=6)
    ], className="mb-4"),
    
    # Top Concerns Section
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("Top Concerns by Income Group", className="card-title mb-3"),
                    html.Div(id='top-concerns')
                ])
            ])
        ], width=12)
    ], className="mb-4"),
    
    # Key Insights
    dbc.Row([
        dbc.Col([
            dbc.Card([
                dbc.CardBody([
                    html.H5("ğŸ” Key Insights", className="card-title mb-3"),
                    html.Div(id='key-insights')
                ], style={'backgroundColor': '#eff6ff'})
            ])
        ], width=12)
    ], className="mb-4")
    
], fluid=True, style={'backgroundColor': COLORS['bg']})

# Callbacks
@app.callback(
    [Output('kpi-total', 'children'),
     Output('kpi-avg', 'children'),
     Output('kpi-positive', 'children'),
     Output('kpi-negative', 'children'),
     Output('sentiment-pie', 'figure'),
     Output('income-bar', 'figure'),
     Output('sector-bar', 'figure'),
     Output('intensity-bar', 'figure'),
     Output('timeline-chart', 'figure'),
     Output('top-concerns', 'children'),
     Output('key-insights', 'children')],
    [Input('sector-filter', 'value'),
     Input('income-filter', 'value')]
)
def update_dashboard(selected_sector, selected_income):
    # Filter data
    filtered_df = df.copy()
    if selected_sector != 'All':
        filtered_df = filtered_df[filtered_df['sector'] == selected_sector]
    if selected_income != 'All':
        filtered_df = filtered_df[filtered_df['income_group'] == selected_income]
    
    # KPIs
    total = len(filtered_df)
    avg_sentiment = f"{filtered_df['sentiment_score'].mean():.3f}"
    positive_pct = f"{(filtered_df['sentiment'].value_counts().get('Positive', 0) / total * 100):.0f}%"
    negative_pct = f"{(filtered_df['sentiment'].value_counts().get('Negative', 0) / total * 100):.0f}%"
    
    # Sentiment Pie
    sentiment_counts = filtered_df['sentiment'].value_counts()
    pie_fig = px.pie(values=sentiment_counts.values, names=sentiment_counts.index,
                     color=sentiment_counts.index,
                     color_discrete_map=COLORS)
    pie_fig.update_traces(textposition='inside', textinfo='percent+label')
    pie_fig.update_layout(showlegend=False, height=300)
    
    # Income Bar
    income_df = filtered_df[filtered_df['income_group'] != 'All'].groupby('income_group')['sentiment_score'].mean().reset_index()
    income_df = income_df.sort_values('sentiment_score')
    income_bar = px.bar(income_df, x='sentiment_score', y='income_group', 
                        orientation='h', color='sentiment_score',
                        color_continuous_scale=['red', 'yellow', 'green'])
    income_bar.update_layout(showlegend=False, height=300, xaxis_title="Avg Sentiment Score",
                            yaxis_title="", coloraxis_showscale=False)
    income_bar.add_vline(x=0, line_dash="dash", line_color="black", opacity=0.5)
    
    # Sector Bar
    sector_df = filtered_df.groupby('sector')['sentiment_score'].mean().reset_index()
    sector_df = sector_df.sort_values('sentiment_score')
    sector_bar = px.bar(sector_df, x='sentiment_score', y='sector',
                       orientation='h', color='sentiment_score',
                       color_continuous_scale=['red', 'yellow', 'green'])
    sector_bar.update_layout(showlegend=False, height=500, xaxis_title="Avg Sentiment Score",
                            yaxis_title="", coloraxis_showscale=False)
    sector_bar.add_vline(x=0, line_dash="dash", line_color="black", opacity=0.5)
    
    # Intensity Bar
    intensity_sentiment = pd.crosstab(filtered_df['reaction_intensity'], filtered_df['sentiment'])
    intensity_fig = px.bar(intensity_sentiment, barmode='group',
                          color_discrete_map=COLORS)
    intensity_fig.update_layout(height=300, xaxis_title="", yaxis_title="Count",
                               legend_title="Sentiment")
    
    # Timeline
    timeline_df = filtered_df.groupby([filtered_df['timestamp'].dt.date, 'sentiment']).size().reset_index(name='count')
    timeline_fig = px.line(timeline_df, x='timestamp', y='count', color='sentiment',
                          color_discrete_map=COLORS, markers=True)
    timeline_fig.update_layout(height=300, xaxis_title="Date", yaxis_title="Count",
                              legend_title="Sentiment")
    
    # Top Concerns
    concerns_html = []
    for income in ['Low', 'Middle', 'High']:
        concerns = filtered_df[(filtered_df['income_group'] == income) & 
                              (filtered_df['sentiment'] == 'Negative')]
        if len(concerns) > 0:
            top = concerns.nsmallest(3, 'sentiment_score')
            concern_items = [html.Li(f"{row['sector']} ({row['sentiment_score']:.2f}): {row['reaction_text'][:80]}...") 
                           for _, row in top.iterrows()]
            concerns_html.append(
                dbc.Col([
                    html.H6(f"{income} Income", className="fw-bold mb-2"),
                    html.Ul(concern_items, className="small")
                ], width=4)
            )
    
    # Key Insights
    best_sector = sector_df.iloc[-1]
    worst_sector = sector_df.iloc[0]
    insights = dbc.ListGroup([
        dbc.ListGroupItem([
            html.Strong("Most Positive Sector: "),
            f"{best_sector['sector']} (avg: {best_sector['sentiment_score']:.2f})"
        ]),
        dbc.ListGroupItem([
            html.Strong("Most Negative Sector: "),
            f"{worst_sector['sector']} (avg: {worst_sector['sentiment_score']:.2f})"
        ]),
        dbc.ListGroupItem([
            html.Strong("Overall Trend: "),
            f"{'Positive' if float(avg_sentiment) > 0.2 else 'Negative' if float(avg_sentiment) < -0.2 else 'Neutral'} sentiment dominates with {total} reactions analyzed"
        ])
    ], flush=True)
    
    return (total, avg_sentiment, positive_pct, negative_pct, 
            pie_fig, income_bar, sector_bar, intensity_fig, timeline_fig,
            dbc.Row(concerns_html), insights)

if __name__ == '__main__':
    print("ğŸš€ Starting Budget Analysis Dashboard...")
    print("ğŸ“Š Open your browser and go to: http://127.0.0.1:8050")
    print("Press Ctrl+C to stop the server")
    app.run(debug=True)
